# Architecture

## Module Breakdown

### Server Modules

| モジュール | 主要責務 |
| --- | --- |
| API Gateway | HTTPリクエストの受付とルーティングを担う。 |
| Authentication | ユーザー認証とセッション管理を行う。 |
| Authorization | 権限チェックとアクセス制御を提供する。 |
| User Service | ユーザープロフィールとアカウント情報を管理する。 |
| Game Service | ゲーム進行ロジックと対局状態を管理する。 |
| Matchmaking | 対戦相手の検索とマッチングキューを管理する。 |
| Realtime Gateway | WebSocketなどのリアルタイム通信を中継する。 |
| Persistence | データベース読み書きとデータ整合性を担う。 |
| Cache | 頻繁に参照されるデータの高速取得を提供する。 |
| Job Scheduler | 非同期ジョブと定期タスクの実行を管理する。 |
| Notification | メールやプッシュ通知の送信を担当する。 |
| Observability | ログ・メトリクス・トレースの収集を行う。 |

### Client Modules

| モジュール | 主要責務 |
| --- | --- |
| App Shell | 画面全体の初期化と共通レイアウトを提供する。 |
| Routing | 画面遷移とURL状態の同期を管理する。 |
| Auth UI | ログイン/登録など認証関連の画面を提供する。 |
| Lobby | ロビー画面と対局開始の導線を管理する。 |
| Matchmaking UI | マッチング操作と待機状態の表示を担当する。 |
| Game Board | 盤面描画と入力受付を行う。 |
| Game HUD | スコアやターンなど対局情報の表示を提供する。 |
| Realtime Client | サーバとのリアルタイム通信を維持する。 |
| State Store | 共有状態管理とデータフローを整理する。 |
| API Client | サーバAPIへのリクエストとレスポンス処理を担う。 |
| Settings | 設定画面とユーザー設定の変更を管理する。 |
| Notifications UI | 通知バナーやアラートの表示を担当する。 |
| Error Handling | 例外時のフォールバックUIとログ送信を提供する。 |
## Server Responsibilities

- 接続管理
  - 接続時にクライアントIDを発行し、再接続時は同一IDのセッションを復元できるかを判定する。
  - ハートビート間隔を監視し、既定回数のタイムアウトが連続した場合は切断扱いとする。
  - 同時接続数の上限を超えた場合は新規接続を拒否し、理由コードを返す。
- ルーム/マッチング
  - ルーム作成時に必要人数・パスコード有無を検証し、不正な設定は拒否する。
  - マッチングは待機時間とレート差を評価し、許容範囲内の組み合わせのみ成立させる。
  - ルーム入退室は現在の対戦状態を確認し、進行中の場合は観戦のみ許可する。
- 対戦進行
  - ターン開始時にタイマーを設定し、制限時間を超過した場合は自動的に不戦敗を確定する。
  - 手番の進行はサーバーのみが更新し、クライアントからの直接変更要求は拒否する。
  - ラウンド終了条件（規定勝利数・残り手数ゼロなど）を満たしたら結果を確定し、次ラウンドの準備へ移行する。
- 手の検証
  - 受信した手が現在の盤面・手札・ルールに整合するかを判定し、違反手は拒否する。
  - 連続手や禁則手のチェックを行い、判定基準（例: 同一ターン内の重複行動は不可）を明示する。
  - 乱数やシャッフルが必要な場合はサーバーが唯一の決定者となり、再現可能なシードを保持する。
- ログ/リプレイ
  - 重要イベント（接続、手番、結果確定）を時系列で保存し、リプレイ生成の基礎とする。
  - ログは個人情報を除外し、保存期間と取得権限をポリシーで制限する。
  - リプレイ生成時は改ざん検知のためのハッシュを付与し、整合性が取れない場合は公開しない。
- 切断処理
  - 進行中の対戦で切断が発生した場合、猶予時間内に再接続がなければ敗北とする。
  - 両者同時切断の場合は最後に有効だった手番と残り時間を比較し、判定ルールに基づき結果を確定する。
  - 切断による結果確定はログに明示し、ランキングへの反映可否を状況（例: マッチ開始直後の切断）に応じて切り替える。
