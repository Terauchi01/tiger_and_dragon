# Architecture

## Client Responsibilities

- 通信
- 入力/UI
  - ユーザー操作の制約
  - 状態表示の責務
- ゲーム状態表示
- ローカル検証
- AI連携
## Server Responsibilities

- 接続管理
  - 接続時にクライアントIDを発行し、再接続時は同一IDのセッションを復元できるかを判定する。
  - ハートビート間隔を監視し、既定回数のタイムアウトが連続した場合は切断扱いとする。
  - 同時接続数の上限を超えた場合は新規接続を拒否し、理由コードを返す。
- ルーム/マッチング
  - ルーム作成時に必要人数・パスコード有無を検証し、不正な設定は拒否する。
  - マッチングは待機時間とレート差を評価し、許容範囲内の組み合わせのみ成立させる。
  - ルーム入退室は現在の対戦状態を確認し、進行中の場合は観戦のみ許可する。
- 対戦進行
  - ターン開始時にタイマーを設定し、制限時間を超過した場合は自動的に不戦敗を確定する。
  - 手番の進行はサーバーのみが更新し、クライアントからの直接変更要求は拒否する。
  - ラウンド終了条件（規定勝利数・残り手数ゼロなど）を満たしたら結果を確定し、次ラウンドの準備へ移行する。
- 手の検証
  - 受信した手が現在の盤面・手札・ルールに整合するかを判定し、違反手は拒否する。
  - 連続手や禁則手のチェックを行い、判定基準（例: 同一ターン内の重複行動は不可）を明示する。
  - 乱数やシャッフルが必要な場合はサーバーが唯一の決定者となり、再現可能なシードを保持する。
- ログ/リプレイ
  - 重要イベント（接続、手番、結果確定）を時系列で保存し、リプレイ生成の基礎とする。
  - ログは個人情報を除外し、保存期間と取得権限をポリシーで制限する。
  - リプレイ生成時は改ざん検知のためのハッシュを付与し、整合性が取れない場合は公開しない。
- 切断処理
  - 進行中の対戦で切断が発生した場合、猶予時間内に再接続がなければ敗北とする。
  - 両者同時切断の場合は最後に有効だった手番と残り時間を比較し、判定ルールに基づき結果を確定する。
  - 切断による結果確定はログに明示し、ランキングへの反映可否を状況（例: マッチ開始直後の切断）に応じて切り替える。
