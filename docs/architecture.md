# タイガー＆ドラゴン 対戦サーバ/クライアント設計メモ

このドキュメントは、学習用エンジンとは別に、複数人対戦向けに必要なサーバ/クライアントの責務と構成を整理したものです。

## 方針
- 学習は通信なしの高速エンジンで行い、対戦時のみサーバを使用する。
- 対戦サーバは **engine の状態遷移/検証ルール** を利用し、学習と対戦のルール差異を防ぐ。
- ルールの一次資料は `RULES.md` に集約する。

## 対戦サーバの責務
- 接続管理（参加/切断/再接続）
- ルーム管理（人数、席順、開始条件）
- 対戦進行（ターン進行、攻め/受け/パス/1周ボーナス）
- 行動の検証（不正手や不整合の拒否）
- 状態配信（全プレイヤーへの最新状態通知）
- ログ/リプレイ用の履歴保存

## クライアントの責務
- UI表示（手牌、攻め/受け列、ターン表示）
- 入力処理（攻め・受け・パスの選択）
- 通信（サーバとのメッセージ送受信）
- ローカルの補助（入力バリデーション、演出）

## サーバ構成案
- `net/` : 接続とメッセージ送受信
- `lobby/` : ルーム管理と参加制御
- `match/` : 対戦状態の管理と進行
- `rules/` : `engine` を利用した検証
- `log/` : 対戦ログ/リプレイ

## クライアント構成案
- `net/` : 通信層（接続/再接続/受信キュー）
- `ui/` : 画面表示
- `input/` : 操作入力
- `state/` : クライアント表示用状態

## 最小メッセージ案
- `join_room` : ルーム参加
- `start_game` : ゲーム開始通知
- `action` : 攻め/受け/パス/ボーナス選択
- `state` : 状態更新
- `end_game` : ゲーム終了通知
# アーキテクチャ

## Document Outline
- 目的/スコープ
- 背景と課題
- 主要要件（機能/非機能）
- システム全体像（コンテキスト図）
- コンポーネント構成
- データフロー
- デプロイメント構成
- セキュリティ/権限設計
- 可観測性（ログ/メトリクス/トレース）
- 運用/障害対応
- 既知の制約と今後の課題

## Required Diagrams
- **状態遷移図**: 主要ドメインエンティティやワークフローの状態変化と遷移条件を整理し、正常系/例外系の流れを明確化する。
- **シーケンス図**: ユーザー操作やAPI呼び出しに対するコンポーネント間の相互作用を時系列で示し、責務分担と呼び出し順序を可視化する。
- **モジュール相関図**: モジュール（またはサービス）間の依存関係と境界を示し、結合度や変更影響範囲を把握できるようにする。
# Architecture

## Module Breakdown

### Server Modules

| モジュール | 主要責務 |
| --- | --- |
| API Gateway | HTTPリクエストの受付とルーティングを担う。 |
| Authentication | ユーザー認証とセッション管理を行う。 |
| Authorization | 権限チェックとアクセス制御を提供する。 |
| User Service | ユーザープロフィールとアカウント情報を管理する。 |
| Game Service | ゲーム進行ロジックと対局状態を管理する。 |
| Matchmaking | 対戦相手の検索とマッチングキューを管理する。 |
| Realtime Gateway | WebSocketなどのリアルタイム通信を中継する。 |
| Persistence | データベース読み書きとデータ整合性を担う。 |
| Cache | 頻繁に参照されるデータの高速取得を提供する。 |
| Job Scheduler | 非同期ジョブと定期タスクの実行を管理する。 |
| Notification | メールやプッシュ通知の送信を担当する。 |
| Observability | ログ・メトリクス・トレースの収集を行う。 |

### Client Modules

| モジュール | 主要責務 |
| --- | --- |
| App Shell | 画面全体の初期化と共通レイアウトを提供する。 |
| Routing | 画面遷移とURL状態の同期を管理する。 |
| Auth UI | ログイン/登録など認証関連の画面を提供する。 |
| Lobby | ロビー画面と対局開始の導線を管理する。 |
| Matchmaking UI | マッチング操作と待機状態の表示を担当する。 |
| Game Board | 盤面描画と入力受付を行う。 |
| Game HUD | スコアやターンなど対局情報の表示を提供する。 |
| Realtime Client | サーバとのリアルタイム通信を維持する。 |
| State Store | 共有状態管理とデータフローを整理する。 |
| API Client | サーバAPIへのリクエストとレスポンス処理を担う。 |
| Settings | 設定画面とユーザー設定の変更を管理する。 |
| Notifications UI | 通知バナーやアラートの表示を担当する。 |
| Error Handling | 例外時のフォールバックUIとログ送信を提供する。 |
## Room Model

- 1 つのルームは 1 人のホストを持ち、参加者（プレイヤー）と観戦者で構成する。
- プレイヤー数は `min_players=2`, `max_players=5` を厳守する。
- ホストもプレイヤーとしてカウントする。

### 観戦の有無と `max_spectators`

- 観戦機能はルーム単位で有効/無効を切り替える。
- 観戦が無効のルームでは観戦参加を受け付けず、`max_spectators` は参照しない。
- 観戦が有効のルームでは、同時観戦者数の上限を `max_spectators` で制御する。
- `max_spectators` に到達している場合、新規の観戦参加は拒否する。

### 開始条件

- ホストは任意のタイミングで開始操作を行える。
- `max_players` に到達した場合、自動開始を許可する設定を用意する。
- 待機開始からのタイムアウトで自動開始する設定を用意する。
## Client-Server Message Set

The client and server exchange JSON messages grouped into the following categories. Each message lists the minimum required fields.

### Connection
- `connect_request`: `{ "player_id" }`
- `connect_ack`: `{ "player_id", "session_id" }`

### Room Join
- `room_join_request`: `{ "room_id", "player_id" }`
- `room_join_ack`: `{ "room_id", "player_id", "seat_id" }`

### Hand Submission
- `hand_submit`: `{ "room_id", "player_id", "turn_id", "hand" }`
- `hand_submit_ack`: `{ "room_id", "player_id", "turn_id", "accepted" }`

### State Update
- `state_update`: `{ "room_id", "turn_id", "state" }`
- `turn_result`: `{ "room_id", "turn_id", "results" }`

### Termination Notice
- `room_close`: `{ "room_id", "reason" }`
- `disconnect_notice`: `{ "player_id", "reason" }`
## Client Responsibilities

- 通信
- 入力/UI
  - ユーザー操作の制約
  - 状態表示の責務
- ゲーム状態表示
- ローカル検証
- AI連携
## Server Responsibilities

- 接続管理
  - 接続時にクライアントIDを発行し、再接続時は同一IDのセッションを復元できるかを判定する。
  - ハートビート間隔を監視し、既定回数のタイムアウトが連続した場合は切断扱いとする。
  - 同時接続数の上限を超えた場合は新規接続を拒否し、理由コードを返す。
- ルーム/マッチング
  - ルーム作成時に必要人数・パスコード有無を検証し、不正な設定は拒否する。
  - マッチングは待機時間とレート差を評価し、許容範囲内の組み合わせのみ成立させる。
  - ルーム入退室は現在の対戦状態を確認し、進行中の場合は観戦のみ許可する。
- 対戦進行
  - ターン開始時にタイマーを設定し、制限時間を超過した場合は自動的に不戦敗を確定する。
  - 手番の進行はサーバーのみが更新し、クライアントからの直接変更要求は拒否する。
  - ラウンド終了条件（規定勝利数・残り手数ゼロなど）を満たしたら結果を確定し、次ラウンドの準備へ移行する。
- 手の検証
  - 受信した手が現在の盤面・手札・ルールに整合するかを判定し、違反手は拒否する。
  - 連続手や禁則手のチェックを行い、判定基準（例: 同一ターン内の重複行動は不可）を明示する。
  - 乱数やシャッフルが必要な場合はサーバーが唯一の決定者となり、再現可能なシードを保持する。
- ログ/リプレイ
  - 重要イベント（接続、手番、結果確定）を時系列で保存し、リプレイ生成の基礎とする。
  - ログは個人情報を除外し、保存期間と取得権限をポリシーで制限する。
  - リプレイ生成時は改ざん検知のためのハッシュを付与し、整合性が取れない場合は公開しない。
- 切断処理
  - 進行中の対戦で切断が発生した場合、猶予時間内に再接続がなければ敗北とする。
  - 両者同時切断の場合は最後に有効だった手番と残り時間を比較し、判定ルールに基づき結果を確定する。
  - 切断による結果確定はログに明示し、ランキングへの反映可否を状況（例: マッチ開始直後の切断）に応じて切り替える。
